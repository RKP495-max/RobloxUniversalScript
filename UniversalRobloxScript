-- Services
local Players = game:GetService("Players")
local UserInputService = game:GetService("UserInputService")
local RunService = game:GetService("RunService")
local Camera = workspace.CurrentCamera
local LocalPlayer = Players.LocalPlayer
local Lighting = game:GetService("Lighting")

-- Configuration Variables
local contourColor = Color3.fromRGB(255, 0, 0)
local contourTransparency = 0.5
local nameTagSize = 14
local walkSpeed = 16
local flySpeed = 50 -- Speed while flying
local fullbrightEnabled = false
local espEnabled = false
local aimbotEnabled = false
local infiniteJumpEnabled = false
local flyEnabled = false
local lightingOriginalSettings = {}
local bodyVelocity -- Store the BodyVelocity instance

-- Save the original lighting settings
local function saveLightingSettings()
    lightingOriginalSettings = {
        Brightness = Lighting.Brightness,
        ClockTime = Lighting.ClockTime,
        FogEnd = Lighting.FogEnd,
        GlobalShadows = Lighting.GlobalShadows,
        OutdoorAmbient = Lighting.OutdoorAmbient
    }
end

-- Apply Fullbright settings
local function applyFullbright()
    if fullbrightEnabled then
        Lighting.Brightness = 2
        Lighting.ClockTime = 12
        Lighting.FogEnd = 100000
        Lighting.GlobalShadows = false
        Lighting.OutdoorAmbient = Color3.fromRGB(128, 128, 128)
    else
        -- Restore original lighting settings
        Lighting.Brightness = lightingOriginalSettings.Brightness
        Lighting.ClockTime = lightingOriginalSettings.ClockTime
        Lighting.FogEnd = lightingOriginalSettings.FogEnd
        Lighting.GlobalShadows = lightingOriginalSettings.GlobalShadows
        Lighting.OutdoorAmbient = lightingOriginalSettings.OutdoorAmbient
    end
end

-- Toggle Fullbright
local function toggleFullbright()
    fullbrightEnabled = not fullbrightEnabled
    applyFullbright()
    print("Fullbright " .. (fullbrightEnabled and "Enabled" or "Disabled"))
end

-- Toggle ESP
local function toggleESP()
    espEnabled = not espEnabled
    print("ESP " .. (espEnabled and "Enabled" or "Disabled"))

    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer then
            if espEnabled then
                createESP(player)
            else
                removeESP(player)
            end
        end
    end

    -- Update button text
    local menuGui = LocalPlayer.PlayerGui:FindFirstChild("MenuGui")
    if menuGui then
        local espButton = menuGui:FindFirstChild("ESPButton")
        if espButton then
            espButton.Text = "ESP (" .. (espEnabled and "On" or "Off") .. ")"
        end
    end
end

-- Toggle Aimbot
local function toggleAimbot()
    aimbotEnabled = not aimbotEnabled
    print("Aimbot " .. (aimbotEnabled and "Enabled" or "Disabled"))
end

-- Toggle Infinite Jump
local function toggleInfiniteJump()
    infiniteJumpEnabled = not infiniteJumpEnabled
    print("Infinite Jump " .. (infiniteJumpEnabled and "Enabled" or "Disabled"))

    local player = Players.LocalPlayer
    local humanoid = player.Character and player.Character:FindFirstChildOfClass('Humanoid')

    if not humanoid then
        player.CharacterAdded:Wait()
        humanoid = player.Character:FindFirstChildOfClass('Humanoid')
    end

    if infiniteJumpEnabled then
        UserInputService.InputBegan:Connect(function(input, gameProcessed)
            if not gameProcessed and input.KeyCode == Enum.KeyCode.Space then
                humanoid:ChangeState(Enum.HumanoidStateType.Jumping)
            end
        end)
    end
end

-- Toggle Fly
local function toggleFly()
    flyEnabled = not flyEnabled
    print("Fly " .. (flyEnabled and "Enabled" or "Disabled"))

    local player = LocalPlayer
    local character = player.Character
    local humanoid = character and character:FindFirstChildOfClass('Humanoid')

    if flyEnabled then
        if humanoid then
            humanoid.PlatformStand = true -- Prevent physics effects
        end
        
        -- Create BodyVelocity for flying
        bodyVelocity = Instance.new("BodyVelocity")
        bodyVelocity.Velocity = Vector3.new(0, 0, 0)
        bodyVelocity.MaxForce = Vector3.new(4000, 4000, 4000)
        bodyVelocity.Parent = character.PrimaryPart
        
        -- Fly Logic
        RunService.RenderStepped:Connect(function()
            if flyEnabled and character and character:FindFirstChild("HumanoidRootPart") then
                local moveDirection = Vector3.new(0, 0, 0)

                if UserInputService:IsKeyDown(Enum.KeyCode.W) then
                    moveDirection = moveDirection + Camera.CFrame.LookVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.S) then
                    moveDirection = moveDirection - Camera.CFrame.LookVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.A) then
                    moveDirection = moveDirection - Camera.CFrame.RightVector
                end
                if UserInputService:IsKeyDown(Enum.KeyCode.D) then
                    moveDirection = moveDirection + Camera.CFrame.RightVector
                end

                if UserInputService:IsKeyDown(Enum.KeyCode.Space) then
                    bodyVelocity.Velocity = moveDirection * flySpeed + Vector3.new(0, flySpeed, 0) -- Ascend
                elseif UserInputService:IsKeyDown(Enum.KeyCode.LeftControl) then
                    bodyVelocity.Velocity = moveDirection * flySpeed + Vector3.new(0, -flySpeed, 0) -- Descend
                else
                    bodyVelocity.Velocity = moveDirection * flySpeed -- Move forward/backward/side
                end
            else
                bodyVelocity.Velocity = Vector3.new(0, 0, 0)
            end
        end)
    else
        if humanoid then
            humanoid.PlatformStand = false -- Restore physics effects
        end
        if bodyVelocity then
            bodyVelocity:Destroy() -- Clean up BodyVelocity
            bodyVelocity = nil
        end
    end
end

-- Create ESP elements for a player
local function createESP(player)
    local function setupCharacter(character)
        if not character or not character:FindFirstChild("HumanoidRootPart") then return end

        -- Remove existing ESP if present
        local existingHighlight = character:FindFirstChild("ESP_Highlight")
        if existingHighlight then
            existingHighlight:Destroy()
        end

        -- Create a Highlight instance for the character
        local highlight = Instance.new("Highlight")
        highlight.Name = "ESP_Highlight"
        highlight.Adornee = character
        highlight.FillTransparency = 1
        highlight.OutlineTransparency = contourTransparency
        highlight.OutlineColor = contourColor
        highlight.Parent = character

        -- Create a BillboardGui for the name tag
        local head = character:FindFirstChild("Head")
        if head then
            local nameTag = Instance.new("BillboardGui")
            nameTag.Name = "ESP_NameTag"
            nameTag.Adornee = head
            nameTag.Size = UDim2.new(0, 50, 0, 50)
            nameTag.AlwaysOnTop = true
            nameTag.ZIndexBehavior = Enum.ZIndexBehavior.Sibling
            nameTag.Parent = head
            
            local nameLabel = Instance.new("TextLabel")
            nameLabel.Text = player.Name
            nameLabel.Size = UDim2.new(1, 0, 1, 0)
            nameLabel.BackgroundTransparency = 1
            nameLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
            nameLabel.TextStrokeTransparency = 0
            nameLabel.TextSize = nameTagSize
            nameLabel.TextScaled = true
            nameLabel.Parent = nameTag
        end
    end

    if player.Character then
        setupCharacter(player.Character)
    end

    player.CharacterAdded:Connect(function(character)
        character:WaitForChild("HumanoidRootPart")
        wait(1)
        if espEnabled then
            setupCharacter(character)
        end
    end)
end

-- Function to remove ESP elements for a player
local function removeESP(player)
    local character = player.Character
    if character then
        local highlight = character:FindFirstChild("ESP_Highlight")
        if highlight then
            highlight:Destroy()
        end
        local head = character:FindFirstChild("Head")
        if head then
            local nameTag = head:FindFirstChild("ESP_NameTag")
            if nameTag then
                nameTag:Destroy()
            end
        end
    end
end

-- Aim at the closest target
local function aimAtTarget()
    local closestPlayer = nil
    local closestDistance = math.huge
    local mouseLocation = UserInputService:GetMouseLocation()
    
    for _, player in ipairs(Players:GetPlayers()) do
        if player ~= LocalPlayer and player.Character and player.Character:FindFirstChild("Head") then
            local screenPoint, onScreen = Camera:WorldToScreenPoint(player.Character.Head.Position)
            if onScreen then
                local distance = (Vector2.new(screenPoint.X, screenPoint.Y) - mouseLocation).Magnitude
                if distance < closestDistance then
                    closestDistance = distance
                    closestPlayer = player
                end
            end
        end
    end

    if closestPlayer and closestPlayer.Character then
        Camera.CFrame = CFrame.new(Camera.CFrame.Position, closestPlayer.Character.Head.Position)
    end
end

-- Run Aimbot on right mouse button press
RunService.RenderStepped:Connect(function()
    if aimbotEnabled and UserInputService:IsMouseButtonPressed(Enum.UserInputType.MouseButton2) then
        aimAtTarget()
    end
end)

-- Update ESP and Fullbright based on toggles
RunService.RenderStepped:Connect(function()
    if espEnabled then
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer and player.Character and not player.Character:FindFirstChild("ESP_Highlight") then
                createESP(player)
            end
        end
    else
        for _, player in ipairs(Players:GetPlayers()) do
            if player ~= LocalPlayer then
                removeESP(player)
            end
        end
    end
    applyFullbright()
end)

-- Create the menu GUI
local function createMenu()
    local screenGui = Instance.new("ScreenGui")
    screenGui.Name = "MenuGui"
    screenGui.Parent = LocalPlayer:WaitForChild("PlayerGui")

    local menuFrame = Instance.new("Frame")
    menuFrame.Size = UDim2.new(0, 300, 0, 400)
    menuFrame.Position = UDim2.new(0.5, -150, 0.5, -200)
    menuFrame.BackgroundColor3 = Color3.fromRGB(50, 50, 50)
    menuFrame.BorderSizePixel = 0
    menuFrame.Parent = screenGui

    local titleLabel = Instance.new("TextLabel")
    titleLabel.Text = "Features Menu"
    titleLabel.Size = UDim2.new(1, 0, 0, 30)
    titleLabel.BackgroundTransparency = 1
    titleLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    titleLabel.TextSize = 20
    titleLabel.TextStrokeTransparency = 0
    titleLabel.Parent = menuFrame

    -- Button to toggle Fullbright
    local fullbrightButton = Instance.new("TextButton")
    fullbrightButton.Size = UDim2.new(1, 0, 0, 50)
    fullbrightButton.Position = UDim2.new(0, 0, 0.1, 0)
    fullbrightButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    fullbrightButton.BorderSizePixel = 0
    fullbrightButton.Text = "Fullbright (Off)"
    fullbrightButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    fullbrightButton.TextSize = 16
    fullbrightButton.Parent = menuFrame

    fullbrightButton.MouseButton1Click:Connect(function()
        toggleFullbright()
        fullbrightButton.Text = "Fullbright (" .. (fullbrightEnabled and "On" or "Off") .. ")"
    end)

    -- Button to toggle ESP
    local espButton = Instance.new("TextButton")
    espButton.Name = "ESPButton"
    espButton.Size = UDim2.new(1, 0, 0, 50)
    espButton.Position = UDim2.new(0, 0, 0.2, 0)
    espButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    espButton.BorderSizePixel = 0
    espButton.Text = "ESP (Off)"
    espButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    espButton.TextSize = 16
    espButton.Parent = menuFrame

    espButton.MouseButton1Click:Connect(toggleESP)

    -- Button to toggle Aimbot
    local aimbotButton = Instance.new("TextButton")
    aimbotButton.Size = UDim2.new(1, 0, 0, 50)
    aimbotButton.Position = UDim2.new(0, 0, 0.3, 0)
    aimbotButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    aimbotButton.BorderSizePixel = 0
    aimbotButton.Text = "Aimbot (Off)"
    aimbotButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    aimbotButton.TextSize = 16
    aimbotButton.Parent = menuFrame

    aimbotButton.MouseButton1Click:Connect(function()
        toggleAimbot()
        aimbotButton.Text = "Aimbot (" .. (aimbotEnabled and "On" or "Off") .. ")"
    end)

    -- Button to toggle Infinite Jump
    local infiniteJumpButton = Instance.new("TextButton")
    infiniteJumpButton.Size = UDim2.new(1, 0, 0, 50)
    infiniteJumpButton.Position = UDim2.new(0, 0, 0.4, 0)
    infiniteJumpButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    infiniteJumpButton.BorderSizePixel = 0
    infiniteJumpButton.Text = "Infinite Jump (Off)"
    infiniteJumpButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    infiniteJumpButton.TextSize = 16
    infiniteJumpButton.Parent = menuFrame

    infiniteJumpButton.MouseButton1Click:Connect(function()
        toggleInfiniteJump()
        infiniteJumpButton.Text = "Infinite Jump (" .. (infiniteJumpEnabled and "On" or "Off") .. ")"
    end)

    -- Button to toggle Fly
    local flyButton = Instance.new("TextButton")
    flyButton.Size = UDim2.new(1, 0, 0, 50)
    flyButton.Position = UDim2.new(0, 0, 0.5, 0)
    flyButton.BackgroundColor3 = Color3.fromRGB(70, 70, 70)
    flyButton.BorderSizePixel = 0
    flyButton.Text = "Fly (Off)"
    flyButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    flyButton.TextSize = 16
    flyButton.Parent = menuFrame

    flyButton.MouseButton1Click:Connect(function()
        toggleFly()
        flyButton.Text = "Fly (" .. (flyEnabled and "On" or "Off") .. ")"
    end)

    -- Walk Speed Slider
    local walkSpeedSlider = Instance.new("Frame")
    walkSpeedSlider.Size = UDim2.new(1, 0, 0, 60)
    walkSpeedSlider.Position = UDim2.new(0, 0, 0.6, 0)
    walkSpeedSlider.BackgroundColor3 = Color3.fromRGB(100, 100, 100)
    walkSpeedSlider.BorderSizePixel = 0
    walkSpeedSlider.Parent = menuFrame

    local walkSpeedLabel = Instance.new("TextLabel")
    walkSpeedLabel.Size = UDim2.new(1, 0, 0.5, 0)
    walkSpeedLabel.BackgroundTransparency = 1
    walkSpeedLabel.Text = "Walk Speed: " .. walkSpeed
    walkSpeedLabel.TextColor3 = Color3.fromRGB(255, 255, 255)
    walkSpeedLabel.TextSize = 16
    walkSpeedLabel.Parent = walkSpeedSlider

    local sliderBar = Instance.new("Frame")
    sliderBar.Size = UDim2.new(1, 0, 0.5, 0)
    sliderBar.Position = UDim2.new(0, 0, 0.5, 0)
    sliderBar.BackgroundColor3 = Color3.fromRGB(150, 150, 150)
    sliderBar.BorderSizePixel = 0
    sliderBar.Parent = walkSpeedSlider

    local slider = Instance.new("Frame")
    slider.Size = UDim2.new(walkSpeed / 100, 0, 1, 0) -- Set initial size based on default walk speed
    slider.BackgroundColor3 = Color3.fromRGB(0, 255, 0)
    slider.BorderSizePixel = 0
    slider.Parent = sliderBar

    local dragging = false

    local function updateWalkSpeed()
        walkSpeedLabel.Text = "Walk Speed: " .. math.floor(walkSpeed)
        if LocalPlayer.Character and LocalPlayer.Character:FindFirstChildOfClass('Humanoid') then
            LocalPlayer.Character.Humanoid.WalkSpeed = walkSpeed
        end
    end

    sliderBar.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = true
            local function onMove(moveInput)
                if dragging then
                    local newWalkSpeed = math.clamp((moveInput.Position.X - sliderBar.AbsolutePosition.X) / sliderBar.AbsoluteSize.X * 100, 16, 100)
                    walkSpeed = newWalkSpeed
                    slider.Size = UDim2.new(newWalkSpeed / 100, 0, 1, 0)
                    updateWalkSpeed()
                end
            end

            UserInputService.InputChanged:Connect(onMove)
        end
    end)

    sliderBar.InputEnded:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            dragging = false
        end
    end)

    -- Drag functionality for the menu
    local draggingMenu = false
    local dragStart
    local startPos

    local function updateMenuPosition(input)
        local delta = input.Position - dragStart
        menuFrame.Position = UDim2.new(startPos.X.Scale, startPos.X.Offset + delta.X, startPos.Y.Scale, startPos.Y.Offset + delta.Y)
    end

    titleLabel.InputBegan:Connect(function(input)
        if input.UserInputType == Enum.UserInputType.MouseButton1 then
            draggingMenu = true
            dragStart = input.Position
            startPos = menuFrame.Position
            input.Changed:Connect(function()
                if input.UserInputState == Enum.UserInputState.End then
                    draggingMenu = false
                end
            end)
        end
    end)

    UserInputService.InputChanged:Connect(function(input)
        if draggingMenu and input.UserInputType == Enum.UserInputType.MouseMovement then
            updateMenuPosition(input)
        end
    end)

    -- Initialize the menu
    saveLightingSettings()
    applyFullbright()
end

-- Create the menu when the script runs
createMenu()
